<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>

<!-- Firebase App (the core Firebase SDK) -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<!-- Firebase Firestore -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<!-- Firebase Auth -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  
  
  <title>GTEC Conference Facility ‚Äî Admin Dashboard</title>
  <link rel="icon" type="image/png" href="favicon.png">

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
import { auth, onAuthStateChanged, signOut } from "./firebase.js";

onAuthStateChanged(auth, (user) => {
    if (!user || !user.emailVerified) {
        // ‚ùó Redirect UNAUTHENTICATED users to LOGIN
        window.location.replace("index.html");
    }
});

document.getElementById("logoutBtn")?.addEventListener("click", () => {
    signOut(auth).then(() => {
        window.location.replace("index.html");
    });
});
</script>

  
  

  <style>
    :root{
      --bg:#f4f7fb; --card:#ffffff; --muted:#6b7280; --primary:#2563eb; --accent:#0ea5a4; --danger:#ef4444;
      --glass: rgba(255,255,255,0.7);
      --radius:12px;
      --shadow: 0 6px 18px rgba(31,41,55,0.08);
      --sidebar-w:260px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#f8fbff, #f4f7fb);min-height:100vh;color:#0f172a}
    .app{display:flex;gap:20px;min-height:100vh;padding:24px}

    /* Sidebar */
    .sidebar{width:var(--sidebar-w);background:linear-gradient(180deg,var(--card),#f8fafc);border-radius:14px;padding:20px;box-shadow:var(--shadow);flex-shrink:0}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    .brand h1{font-size:16px;margin:0}
    .nav{margin-top:14px}
    .nav button{display:flex;align-items:center;gap:10px;width:100%;padding:10px;border-radius:10px;border:none;background:transparent;color:#0f172a;cursor:pointer;text-align:left;font-weight:600}
    .nav button.active{background:linear-gradient(90deg,rgba(37,99,235,0.12),rgba(14,165,164,0.06));color:var(--primary)}
    .nav .small{font-size:12px;color:var(--muted);font-weight:500}
    .sidebar .quick{margin-top:22px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fbfcff,#fff);box-shadow:inset 0 1px 0 rgba(255,255,255,0.6)}
    .stat{display:flex;justify-content:space-between;gap:8px;margin-bottom:8px}
    .stat .val{font-weight:800}

    /* Main area */
    .main{flex:1}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px}
    .search{flex:1;display:flex;gap:8px}
    .search input{flex:1;padding:10px;border-radius:10px;border:1px solid #e6edf3}
    .actions{display:flex;gap:8px}
    .btn{padding:10px 12px;border-radius:10px;border:none;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(37,99,235,0.12)}

    .card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #eef3f7;text-align:left}
    .table th{background:transparent;color:var(--muted);font-weight:700}
    .table tr:hover td{background:#fbfdff}

    /* Stat cards on dashboard: use 4 across */
    .dashboard-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}

    /* colored stat cards */
    .stat-card{border-radius:12px;padding:18px;color:#0f172a;transition:transform .18s ease,box-shadow .18s ease}
    .stat-card:hover{transform:translateY(-6px);box-shadow:0 14px 40px rgba(31,41,55,0.12)}
    .stat-card .small{opacity:0.9}
    .stat-card h2{margin:6px 0 0;font-size:28px}

    .stat-red{background:linear-gradient(180deg,#fff5f5,#fff);border:1px solid rgba(239,68,68,0.08)}
    .stat-red .label-pill{background:#fee2e2;color:#b91c1c;border-radius:999px;padding:6px 10px;font-weight:700}

    .stat-ash{background:linear-gradient(180deg,#f6f6f7,#fff);border:1px solid rgba(15,23,42,0.03)}
    .stat-ash .label-pill{background:#f3f4f6;color:#374151;border-radius:999px;padding:6px 10px;font-weight:700}

    .stat-green{background:linear-gradient(180deg,#f0fdf4,#fff);border:1px solid rgba(16,185,129,0.06)}
    .stat-green .label-pill{background:#dcfce7;color:#065f46;border-radius:999px;padding:6px 10px;font-weight:700}

    /* Forms & modal */
    .form-row{display:flex;gap:10px}
    label{font-size:13px;color:var(--muted)}
    input,select{padding:10px;border-radius:8px;border:1px solid #e6edf3;width:100%}

    .right-actions{display:flex;gap:8px;align-items:center}
    .pill{padding:6px 10px;border-radius:999px;background:#eff6ff;color:var(--primary);font-weight:700;font-size:13px}

    footer{margin-top:20px;text-align:center;color:var(--muted);font-size:13px}

    /* Responsive */
    @media (max-width:1000px){.dashboard-cards{grid-template-columns:repeat(1,1fr)} .grid{grid-template-columns:repeat(1,1fr)} .sidebar{display:none} .app{padding:12px}}

    /* small helpers */
    .muted{color:var(--muted)}
    .right{float:right}
    .flex{display:flex;align-items:center;gap:10px}

    /* custom invoice preview styling */
    #invoicePreview{max-width:800px;margin:0 auto}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="app">


    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
  <img src="logo1.jpg" alt="GTEC Logo" class="logo" style="height:50px; width:auto;">
<div><h1>GTEC Conference</h1><div class="small muted">Facility Management</div></div></div>
            <div style="margin-top:12px;font-size:13px;color:var(--muted);">
  üëãWelcome back <b id="loggedInUser">Loading...</b>




<style>
  /* ===== NAV BASE ===== */
.nav {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.nav button {
  padding: 10px 14px;
  border: none;
  background: #f4f4f4;
  border-radius: 6px;
  text-align: left;
  cursor: pointer;
}

.nav button.active {
  background: #007bff;
  color: #fff;
}

/* ===== HAMBURGER BUTTON ===== */
.menu-toggle {
  display: none;
  font-size: 24px;
  background: none;
  border: none;
  cursor: pointer;
  margin-bottom: 10px;
}

/* ===== MOBILE STYLES ===== */
@media (max-width: 768px) {

  .menu-toggle {
    display: block;
  }

  .nav {
    display: none;
    background: #fff;
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 6px 18px rgba(0,0,0,.15);
  }

  .nav.show {
    display: flex;
  }

  .nav button {
    font-size: 15px;
  }
}

/* ===== MESSAGE DOT ===== */
#newMessageDot {
  display: none;
  background: red;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-left: 6px;
}

  /* FORCE HAMBURGER VISIBILITY */
#menuToggle {
  display: none;
}

@media (max-width: 768px) {
  #menuToggle {
    display: block !important;
    font-size: 26px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    color: #000;
    z-index: 5000;
  }
}

</style>

              
      <button id="menuToggle" class="menu-toggle">‚ò∞</button>
     
      <div class="nav" id="mobileNav" role="navigation">
        <button class="active" data-page="dashboard">üéØ Dashboard</button>
        <button data-page="institutions">üè´ Institutions</button>
        <button data-page="venues">üèõÔ∏è Halls</button>
        <button data-page="invoices">üßæ Invoices</button>
        <button data-page="users">üë• Users & Roles</button>
        <button data-page="reports">üìä Reports</button>
        
        <button id="messagesBtn" data-page="messages">
  üì© Contact Messages
  <span id="newMessageDot" style="display:none; background:red; width:10px; height:10px; border-radius:50%; margin-left:5px; display:inline-block;"></span>
</button>

        <button data-page="news">üìú News Subscribers</button>
        <button data-page="documents">üóÇÔ∏è Documents</button>
        <button data-page="settings">‚öôÔ∏è Settings</button>
      </div>

      <div class="quick">
        <div class="stat"><div><div class="small muted">Bookings</div><div class="val" id="statBookings">0</div></div><div class="pill">Live</div></div>
      </div>


</div>

    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar">
        <div class="search">
          <input id="globalSearch" placeholder="Search institutions, invoices, venues..." />
          <div class="right-actions">
            <button class="btn ghost" id="btnExport">Export CSV</button>
            <button class="btn" id="btnNewBooking">+ New Booking</button>
          </div>
          <button id="logoutBtn">Logout</button>
        </div>
        <div class="flex">
          <div style="text-align:right"><div class="muted">Today</div><div style="font-weight:800"> <span id="todayDate"></span></div></div>
        </div>
      </div>

      <!-- PAGES -->

      <section id="dashboard" class="page">
        <!-- Dashboard stat cards: 4 cards -->
        <div class="dashboard-cards">
          <div class="card stat-card">
            <div class="small muted">Total Bookings</div>
            <h2 id="dashBookings">0</h2>
            <div class="muted">Bookings by venue below</div>
          </div>

          <div class="card stat-card stat-red">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="small muted">Pending</div>
              <div class="label-pill">üî¥ Pending</div>
            </div>
            <h2 id="dashPending">0</h2>
            <div class="muted">Awaiting events</div>
          </div>

          <div class="card stat-card stat-ash">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="small muted">Cancelled</div>
              <div class="label-pill">‚ö™ Cancelled</div>
            </div>
            <h2 id="dashCancelled">0</h2>
            <div class="muted">Bookings cancelled</div>
          </div>

          <div class="card stat-card stat-green">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="small muted">Completed</div>
              <div class="label-pill">üü¢Completed</div>
            </div>
            <h2 id="dashCompleted">0</h2>
            <div class="muted">Successfully completed</div>
          </div>
        </div>

        <div class="card" style="margin-bottom:12px">
          <canvas id="venueChart" height="90"></canvas>
        </div>

        <div class="card">
          <h3 style="margin-top:0">Recent Invoices</h3>
          <table class="table" id="recentInvoicesTable"><thead><tr><th>Invoice</th><th>Coordinator</th><th>Venue</th><th>Amount</th><th>Status</th></tr></thead><tbody></tbody></table>
        </div>
      </section>


      
      <section id="institutions" class="page hidden">
        <div class="card" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 style="margin:0">Institutions</h3>
          <div><button class="btn ghost" id="btnImportCSV">Import CSV</button> <button class="btn" id="btnAddInstitution">+ Add Institution</button></div>
        </div>
        <div class="card">
          <div style="overflow-x:auto; overflow-y:auto; max-height:500px; border:1px solid #ccc; padding:5px;">
          <table class="table" id="institutionsTable">
  <thead>
    <tr>
      <th>Timestamp</th>
      <th>Name of Applicant</th>
      <th>Name of Institution/Organization/Person</th>
      <th>Number of Participants</th>
      <th>Venue</th>
      <th>Event Description</th>
      <th>Event Start Date</th>
      <th>Event End Date</th>
      <th>Additional Services</th>
      <th>Time Event Starts (AM/PM)</th>
      <th>Time Event Ends (AM/PM)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
          </div>

        </div>
      </section>

      <section id="venues" class="page hidden">
        <div class="card" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 style="margin:0">Halls & Pricing</h3>
          <div><button class="btn" id="btnAddVenue">+ Add Venue</button></div>
        </div>
        <div class="card">
          <table class="table" id="venuesTable"><thead><tr><th>Venue</th><th>Default Cost</th><th>With Services</th><th>Action</th></tr></thead><tbody></tbody></table>
        </div>
      </section>


      <section id="invoices" class="page hidden">
        <div class="card" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 style="margin:0">Invoices</h3>
          <div><button class="btn" id="btnGenerateInvoice">+ Generate</button></div>
        </div>
        <div class="card">
          <table class="table" id="invoicesTable"><thead><tr><th>Invoice #</th><th>Coordinator</th><th>Venue</th><th>Amount</th><th>Date</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table>
        </div>
      </section>



      
      
      <!-- Users & Roles -->
      <section id="users" class="page hidden">
        <div class="card" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 style="margin:0">Users & Roles</h3>
          <div><button class="btn" id="btnAddUser">+ Add User</button></div>
        </div>
        <div class="card">
          <table class="table" id="usersTable"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Action</th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- Report -->
        <section id="reports" class="page hidden">
        <div class="card">
          <h3>Reports</h3>
          <p class="muted">Quick revenue and booking exports</p>
          <div style="display:flex;gap:12px;margin-top:12px">
            <div style="flex:1" class="card"><b>Total Revenue</b><div id="reportRevenue">GHS 0</div></div>
            <div style="flex:1" class="card"><b>Bookings Count</b><div id="reportBookings">0</div></div>
            <div style="flex:1" class="card"><b>Pending</b><div id="reportPending">0</div></div>
          </div>
        </div>
      </section>


      <!-- Contact Messages -->
      <section id="messages" class="page hidden">
  <div class="card">
    <h3>Contact Messages</h3>
    <table class="table" id="contactMessagesTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Email</th>
          <th>Message</th>
          <th>Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

      
      

      

          <!-- News Subscription -->
<section id="news" class="page">
  <div class="card" style="margin-bottom:12px">
    <h3>News Subscription</h3>
    <p class="muted">Emails collected from website newsletter form</p>
  </div>

  <div class="card">
    <table class="table" id="subscriptionsTable">
  <thead>
    <tr>
      <th>#</th>
      <th>Email</th>
      <th>Date & Time Subscribed</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

  </div>
</section>


      <!-- Documents Archive -->
<section id="documents" class="page hidden">
  <div class="card">
    <h3>Documents</h3>
    <p class="muted">Official documents available for download</p>

    <div style="margin-top:16px">
      <table class="table">
        <thead>
          <tr>
            <th>#</th>
            <th>Document Name</th>
            <th>Type</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td>Hall Usage Guidelines</td>
            <td>PDF</td>
            <td>
              <a href="documents/Guidelines for Booking _ 2026.pdf" download class="btn">
                ‚¨á Download
              </a>
            </td>
          </tr>

          <tr>
            <td>2</td>
            <td>Booking Terms & Conditions</td>
            <td>PDF</td>
            <td>
              <a href="documents/Guidelines for Booking _ 2026.pdf" download class="btn">
                ‚¨á Download
              </a>
            </td>
          </tr>

          <tr>
            <td>3</td>
            <td>Price List</td>
            <td>DOCX</td>
            <td>
              <a href="documents/price-list.docx" download class="btn">
                ‚¨á Download
              </a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

      
      

     <!-- Settings - Profile -->
<section id="settings" class="page hidden">
  <div class="card">
    <h3>Profile</h3>
    <p class="muted">Manage your account and change your password</p>

    <div style="margin-top:16px">
      <label>Email</label>
      <input id="profileEmail" type="email" disabled />

      <div style="height:12px"></div>

      <label>New Password</label>
      <input id="newPassword" type="password" placeholder="Enter new password" />

      <div style="height:12px"></div>

      <label>Confirm Password</label>
      <input id="confirmPassword" type="password" placeholder="Confirm new password" />

      <div style="height:16px"></div>

      <button id="updatePasswordBtn" class="btn primary">
        Update Password
      </button>

      <p id="profileMessage" class="muted" style="margin-top:10px; display:none;"></p>
    </div>
  </div>
</section>

      

      <footer>GTEC Conference Facility Dashboard - 2025</footer>
    </main>
  </div>

  <!-- MODALS (hidden) -->
  <div id="modalRoot"></div>

  <script>
// Your web app's Firebase configuration

const firebaseConfig = {
  apiKey: "AIzaSyA80t2tr136ihN57YQWwD4nYcPhyutACX4",
  authDomain: "userlogin-44d0a.firebaseapp.com",
  projectId: "userlogin-44d0a",
  storageBucket: "userlogin-44d0a.firebasestorage.app",
  messagingSenderId: "47108256134",
  appId: "1:47108256134:web:60888fa5f06dfb075d3c07",
  measurementId: "G-ZCVWTTFT2H"
};
    
firebase.initializeApp(firebaseConfig);

firebase.auth().onAuthStateChanged(user => {
  if (!user) window.location.href = "index.html";
});

function logout() {
  firebase.auth().signOut().then(() => {
    window.location.href = "index.html";
  });
}

</script>
   

<!-- Settings - Profile -->
<script>
firebase.auth().onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  // Show logged-in email
  document.getElementById("profileEmail").value = user.email;
});

document.getElementById("updatePasswordBtn").addEventListener("click", async () => {
  const newPassword = document.getElementById("newPassword").value;
  const confirmPassword = document.getElementById("confirmPassword").value;
  const msg = document.getElementById("profileMessage");

  msg.style.display = "block";

  if (!newPassword || !confirmPassword) {
    msg.textContent = "Please fill all password fields.";
    msg.style.color = "red";
    return;
  }

  if (newPassword.length < 6) {
    msg.textContent = "Password must be at least 6 characters.";
    msg.style.color = "red";
    return;
  }

  if (newPassword !== confirmPassword) {
    msg.textContent = "Passwords do not match.";
    msg.style.color = "red";
    return;
  }

  try {
    const user = firebase.auth().currentUser;
    await user.updatePassword(newPassword);

    msg.textContent = "Password updated successfully.";
    msg.style.color = "green";

    document.getElementById("newPassword").value = "";
    document.getElementById("confirmPassword").value = "";

  } catch (error) {
    console.error(error);

    if (error.code === "auth/requires-recent-login") {
      msg.textContent = "Please log out and log in again to change your password.";
    } else {
      msg.textContent = "Failed to update password.";
    }
    msg.style.color = "red";
  }
});
</script>

  
  
  

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
  const sheetCSVUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLDl2oNe9mONdejXYfXqk3hjdVZUWHsfdN47F54BS4nyufgxV_o2VaCm-upReu1ERhZZQ173TfDJ3B/pub?gid=2055986518&single=true&output=csv";

  function loadInstitutions() {
    Papa.parse(sheetCSVUrl, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const data = results.data;
        const tbody = document.querySelector("#institutionsTable tbody");
        tbody.innerHTML = ""; // Clear previous data

        data.forEach(row => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row["Timestamp"] || ""}</td>
            <td>${row["Name of Applicant"] || ""}</td>
            <td>${row["Name of Institution/Organization/Person"] || ""}</td>
            <td>${row["Number of Participants"] || ""}</td>
            <td>${row["Venue"] || ""}</td>
            <td>${row["Event Description"] || ""}</td>
            <td>${row["Event Start Date"] || ""}</td>
            <td>${row["Event End Date"] || ""}</td>
            <td>${row["Additional Services"] || ""}</td>
            <td>${row["Time Event Starts (Please indicate : AM/PM)."] || ""}</td>
            <td>${row["Time Event Ends (Please indicate : AM/PM)"] || ""}</td>
          `;
          tbody.appendChild(tr);
        });
      },
      error: function(error) {
        console.error("Error loading CSV data:", error);
      }
    });
  }

  // Load institutions on page load
  document.addEventListener("DOMContentLoaded", loadInstitutions);
</script>

  

  <script>
    /*******************************
     * Demo data + persistence
     *******************************/
    const sampleVenues = [
      {id:1,name:'Effah Hall (Full Auditorium)', base:12000, withServices:14000},
      {id:2,name:'Effah Hall (Ground Floor)', base:10000, withServices:12000},
      {id:3,name:'Ahmed Jinapor Hall', base:5000, withServices:5000},
      {id:4,name:'Kwame Dattey Hall', base:3500, withServices:3500},
      {id:5,name:'Nikoi Kotey Hall', base:2500, withServices:2500}
    ];

    const sampleInstitutions = [
      {id:1,name:'University of Ghana', coordinator:'Evelyn', email:'evelyn@ug.edu.gh'},
      {id:2,name:'Ghana Health Service', coordinator:'Samuel', email:'samuel@ghs.gov.gh'},
      {id:3,name:'Ministry of Education', coordinator:'Amos', email:'amos@moe.gov.gh'}
    ];

    const sampleUsers = [
      {id:1,name:'Super Admin',email:'super@gtec.edu.gh',role:'Super Admin'},
      {id:2,name:'Finance',email:'finance@gtec.edu.gh',role:'Finance'},
      {id:3,name:'Coordinator',email:'coord@gtec.edu.gh',role:'Coordinator'}
    ];

    // invoices example
    let venues = JSON.parse(localStorage.getItem('gtec_venues')) || sampleVenues;
    let institutions = JSON.parse(localStorage.getItem('gtec_institutions')) || sampleInstitutions;
    let users = JSON.parse(localStorage.getItem('gtec_users')) || sampleUsers;
    let invoices = JSON.parse(localStorage.getItem('gtec_invoices')) || [];

    function persist(){
      localStorage.setItem('gtec_venues', JSON.stringify(venues));
      localStorage.setItem('gtec_institutions', JSON.stringify(institutions));
      localStorage.setItem('gtec_users', JSON.stringify(users));
      localStorage.setItem('gtec_invoices', JSON.stringify(invoices));
      updateUI();
    }

    /*******************************
     * Utilities
     *******************************/
    function qs(sel){return document.querySelector(sel)}
    function qsa(sel){return Array.from(document.querySelectorAll(sel))}

    function showPage(pageId){
      qsa('.page').forEach(p=>p.classList.add('hidden'));
      qs('#'+pageId).classList.remove('hidden');
      qsa('.nav button').forEach(b=>b.classList.toggle('active', b.dataset.page===pageId));
    }

    // format currency
    function fmt(v){return (v||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});}

    // today's date
    qs('#todayDate').textContent = new Date().toLocaleDateString();

    /*******************************
     * Renderers
     *******************************/
    function renderInstitutions(){
      const tbody = qs('#institutionsTable tbody'); tbody.innerHTML = '';
      institutions.forEach(inst=>{
        const count = invoices.filter(i=>i.institutionId===inst.id).length;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${inst.name}</td><td>${inst.coordinator||''}</td><td>${inst.email||''}</td><td>${count}</td><td><button data-id='${inst.id}' class='btn ghost editInst'>Edit</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function renderVenues(){
      const tbody = qs('#venuesTable tbody'); tbody.innerHTML = '';
      venues.forEach(v=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${v.name}</td><td>GHS ${fmt(v.base)}</td><td>GHS ${fmt(v.withServices)}</td><td><button data-id='${v.id}' class='btn ghost editVenue'>Edit</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function renderUsers(){
      const tbody = qs('#usersTable tbody'); tbody.innerHTML = '';
      users.forEach(u=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u.name}</td><td>${u.email}</td><td>${u.role}</td><td><button data-id='${u.id}' class='btn ghost editUser'>Edit</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function renderInvoices(){
      const tbody = qs('#invoicesTable tbody'); tbody.innerHTML = '';
      invoices.slice().reverse().forEach(inv=>{
        const inst = institutions.find(i=>i.id===inv.institutionId) || {name:inv.institution};
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${inv.invoiceNo}</td><td>${inst.name || inv.institution}</td><td>${inv.venue}</td><td>GHS ${fmt(inv.amount)}</td><td>${inv.date}</td><td>${inv.status}</td><td><button class='btn ghost previewInv' data-id='${inv.id}'>Preview</button> <button class='btn' data-id='${inv.id}' data-action='download'>PDF</button></td>`;
        tbody.appendChild(tr);
      });

      // recent
      const recentBody = qs('#recentInvoicesTable tbody'); recentBody.innerHTML = '';
      invoices.slice(-5).reverse().forEach(inv=>{
        const inst = institutions.find(i=>i.id===inv.institutionId) || {name:inv.institution};
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${inv.invoiceNo}</td><td>${inst.name||inv.institution}</td><td>${inv.venue}</td><td>GHS ${fmt(inv.amount)}</td><td>${inv.status}</td>`;
        recentBody.appendChild(tr);
      });
    }

    function updateStats(){
      // Keep booking-related stats updated from local invoices
      qs('#statBookings').textContent = invoices.length;
      qs('#dashBookings').textContent = invoices.length;
      qs('#reportBookings').textContent = invoices.length;

      // Keep reportRevenue computed locally (if you have amounts in invoices)
      const rev = invoices.reduce((s,i)=>s + (i.amount||0),0);
      qs('#reportRevenue').textContent = 'GHS ' + fmt(rev);

      // NOTE: dashPending/dashCancelled/dashCompleted are populated via fetchLiveStats()
    }

    function updateUI(){
      renderInstitutions(); renderVenues(); renderUsers(); renderInvoices(); updateStats(); renderChart();
    }

    
    /*******************************
 * Charts
 *******************************/
let venueChart = null;
async function renderChart(){
  const ctx = document.getElementById('venueChart').getContext('2d');

  // Fetch CSV data
  Papa.parse(sheetCSVUrl, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results){
      const data = results.data;

      // Venue names (use your defined sample venues)
      const labels = venues.map(v => v.name);

      // Count bookings per venue from CSV
      const counts = labels.map(venueName => 
        data.filter(row => row["Venue"] === venueName).length
      );

      // Destroy existing chart if any
      if(venueChart) venueChart.destroy();

      // Create chart
      venueChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Bookings by Venue',
            data: counts,
            backgroundColor: 'rgba(37, 99, 235, 0.7)',
            borderColor: 'rgba(37, 99, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, precision: 0 } }
        }
      });
    },
    error: function(err){
      console.error("Failed to load CSV for chart:", err);
    }
  });
}




    
    /*******************************
     * Interactions: Nav + buttons
     *******************************/
   qsa('.nav button').forEach(b =>
  b.addEventListener('click', () => {
    showPage(b.dataset.page);

    if (b.dataset.page === "news") {  // <-- match your section ID
      loadSubscriptions();
    }
  })
);

    


    // new booking button opens invoice modal
    qs('#btnNewBooking').addEventListener('click', ()=>openInvoiceModal());
    qs('#btnGenerateInvoice').addEventListener('click', ()=>openInvoiceModal());

    qs('#btnAddInstitution').addEventListener('click', ()=>openInstitutionModal());
    qs('#btnAddVenue').addEventListener('click', ()=>openVenueModal());
    qs('#btnAddUser').addEventListener('click', ()=>openUserModal());

    // export CSV
    qs('#btnExport').addEventListener('click', ()=>{
      const rows = ['InvoiceNo,Institution,Coordinator,Email,Venue,Amount,Date,Status'];
      invoices.forEach(i=>{
        const inst = institutions.find(x=>x.id===i.institutionId) || {name:i.institution, coordinator:'', email:''};
        rows.push([i.invoiceNo, inst.name, inst.coordinator||'', inst.email||'', `\"${i.venue}\"`, i.amount, i.date, i.status].join(','));
      });
      const blob = new Blob([rows.join('\n')],{type:'text/csv'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'invoices_export.csv'; a.click();
    });

    // global search
qs('#globalSearch').addEventListener('input', function(){
  const q = this.value.toLowerCase();

  // --- FILTER INSTITUTIONS ---
  const instTbody = qs('#institutionsTable tbody');
  instTbody.innerHTML = ''; // clear table
  if(q){
    Papa.parse(sheetCSVUrl, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const data = results.data;
        data.forEach(row => {
          const combined = [
            row["Timestamp"] || "",
            row["Name of Applicant"] || "",
            row["Name of Institution/Organization/Person"] || "",
            row["Number of Participants"] || "",
            row["Venue"] || "",
            row["Event Description"] || "",
            row["Event Start Date"] || "",
            row["Event End Date"] || "",
            row["Additional Services"] || "",
            row["Time Event Starts (Please indicate : AM/PM)."] || "",
            row["Time Event Ends (Please indicate : AM/PM)"] || ""
          ].join(' ').toLowerCase();
          
          if(combined.includes(q)){
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${row["Timestamp"] || ""}</td>
              <td>${row["Name of Applicant"] || ""}</td>
              <td>${row["Name of Institution/Organization/Person"] || ""}</td>
              <td>${row["Number of Participants"] || ""}</td>
              <td>${row["Venue"] || ""}</td>
              <td>${row["Event Description"] || ""}</td>
              <td>${row["Event Start Date"] || ""}</td>
              <td>${row["Event End Date"] || ""}</td>
              <td>${row["Additional Services"] || ""}</td>
              <td>${row["Time Event Starts (Please indicate : AM/PM)."] || ""}</td>
              <td>${row["Time Event Ends (Please indicate : AM/PM)"] || ""}</td>
            `;
            instTbody.appendChild(tr);
          }
        });
      }
    });
  } else {
    // reload all institutions if search is empty
    loadInstitutions();
  }

  // --- FILTER INVOICES ---
  const tbody = qs('#invoicesTable tbody'); tbody.innerHTML = '';
  invoices.filter(inv=> [inv.invoiceNo,inv.venue,inv.status,(inv.institution||'')].join(' ').toLowerCase().includes(q)).forEach(inv=>{
    const inst = institutions.find(i=>i.id===inv.institutionId) || {name:inv.institution};
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${inv.invoiceNo}</td><td>${inst.name||inv.institution}</td><td>${inv.venue}</td><td>GHS ${fmt(inv.amount)}</td><td>${inv.date}</td><td>${inv.status}</td><td><button class='btn ghost previewInv' data-id='${inv.id}'>Preview</button> <button class='btn' data-id='${inv.id}' data-action='download'>PDF</button></td>`;
    tbody.appendChild(tr);
  });
});

    

    /*******************************
     * Modal helpers (simple)
     *******************************/
    function openModal(html){
      const root = qs('#modalRoot');
      const wrap = document.createElement('div');
      wrap.style= 'position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:9999';
      wrap.innerHTML = `<div style='max-width:820px;width:100%;padding:18px;background:var(--card);border-radius:12px;box-shadow:var(--shadow)'>${html}<div style='text-align:right;margin-top:12px'><button id='closeModal' class='btn ghost'>Close</button></div></div>`;
      root.appendChild(wrap);
      wrap.querySelector('#closeModal').addEventListener('click', ()=>root.removeChild(wrap));
      return wrap;
    }

    /*******************************
     * Institution CRUD modal
     *******************************/
    function openInstitutionModal(inst){
      inst = inst || {name:'',coordinator:'',email:''};
      const html = `
        <h3>${inst.id? 'Edit':'Add'} Institution</h3>
        <div style='display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px'>
          <div><label>Name</label><input id='instName' value='${inst.name||''}' /></div>
          <div><label>Coordinator</label><input id='instCoord' value='${inst.coordinator||''}' /></div>
          <div style='grid-column:1/3'><label>Email</label><input id='instEmail' value='${inst.email||''}' /></div>
        </div>
        <div style='margin-top:12px;text-align:right'><button id='saveInst' class='btn'>Save</button></div>
      `;
      const modal = openModal(html);
      modal.querySelector('#saveInst').addEventListener('click', ()=>{
        const name = modal.querySelector('#instName').value.trim();
        const coordinator = modal.querySelector('#instCoord').value.trim();
        const email = modal.querySelector('#instEmail').value.trim();
        if(!name) return alert('Enter institution name');
        if(inst.id){ // update
          const idx = institutions.findIndex(i=>i.id===inst.id); institutions[idx] = {...institutions[idx], name, coordinator, email};
        } else {
          const id = Date.now(); institutions.push({id,name,coordinator,email});
        }
        persist(); document.querySelector('#modalRoot').innerHTML='';
      });
    }

    document.addEventListener('click', (e)=>{
      if(e.target.classList.contains('editInst')){
        const id = Number(e.target.dataset.id); const inst = institutions.find(i=>i.id===id); openInstitutionModal(inst);
      }
    });

    /*******************************
     * Venue CRUD modal
     *******************************/
    function openVenueModal(v){
      v = v || {name:'',base:'',withServices:''};
      const html = `
        <h3>${v.id? 'Edit':'Add'} Venue</h3>
        <div style='display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px'>
          <div><label>Venue Name</label><input id='vName' value='${v.name||''}' /></div>
          <div style='display:flex;gap:10px'><div style='flex:1'><label>Base Cost</label><input id='vBase' value='${v.base||''}' type='number' /></div><div style='flex:1'><label>With Services Cost</label><input id='vWith' value='${v.withServices||''}' type='number' /></div></div>
        </div>
        <div style='margin-top:12px;text-align:right'><button id='saveVenue' class='btn'>Save</button></div>
      `;
      const modal = openModal(html);
      modal.querySelector('#saveVenue').addEventListener('click', ()=>{
        const name = modal.querySelector('#vName').value.trim();
        const base = Number(modal.querySelector('#vBase').value)||0;
        const withServices = Number(modal.querySelector('#vWith').value)||base;
        if(!name) return alert('Enter venue name');
        if(v.id){ const idx = venues.findIndex(x=>x.id===v.id); venues[idx] = {...venues[idx], name, base, withServices}; }
        else venues.push({id:Date.now(), name, base, withServices});
        persist(); document.querySelector('#modalRoot').innerHTML='';
      });
    }

    document.addEventListener('click', (e)=>{
      if(e.target.classList.contains('editVenue')){
        const id = Number(e.target.dataset.id); const v = venues.find(i=>i.id===id); openVenueModal(v);
      }
    });

    /*******************************
     * User CRUD
     *******************************/
    function openUserModal(u){
      u = u || {name:'',email:'',role:'Coordinator'};
      const html = `
        <h3>${u.id? 'Edit':'Add'} User</h3>
        <div style='display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px'>
          <div><label>Name</label><input id='uName' value='${u.name||''}' /></div>
          <div><label>Email</label><input id='uEmail' value='${u.email||''}' /></div>
          <div style='grid-column:1/3'><label>Role</label><select id='uRole'><option>Super Admin</option><option>Admin</option><option>Finance</option><option>Coordinator</option></select></div>
        </div>
        <div style='margin-top:12px;text-align:right'><button id='saveUser' class='btn'>Save</button></div>
      `;
      const modal = openModal(html);
      modal.querySelector('#uRole').value = u.role || 'Coordinator';
      modal.querySelector('#saveUser').addEventListener('click', ()=>{
        const name = modal.querySelector('#uName').value.trim();
        const email = modal.querySelector('#uEmail').value.trim();
        const role = modal.querySelector('#uRole').value;
        if(!name || !email) return alert('Enter user name and email');
        if(u.id){ const idx = users.findIndex(x=>x.id===u.id); users[idx] = {...users[idx], name, email, role}; }
        else users.push({id:Date.now(), name, email, role});
        persist(); document.querySelector('#modalRoot').innerHTML='';
      });
    }
    document.addEventListener('click', (e)=>{ if(e.target.classList.contains('editUser')){ const id=Number(e.target.dataset.id); openUserModal(users.find(u=>u.id===id)); } });

    /*******************************
     * Invoice Modal + generate
     *******************************/
    function generateInvoiceNo(){
      const prefix='GTEC'; const t = Date.now().toString().slice(-6); return `${prefix}-${t}`;
    }

    function openInvoiceModal(prefill){
      const instOptions = institutions.map(i=>`<option value='${i.id}'>${i.name}</option>`).join('');
      const venueOptions = venues.map(v=>`<option value='${v.name}'>${v.name}</option>`).join('');
      const html = `
        <h3>Generate Invoice</h3>
        <div style='display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px'>
          <div><label>Institution</label><select id='invInst'><option value=''>-- select --</option>${instOptions}</select></div>
          <div><label>Coordinator Email</label><input id='invEmail' placeholder='coordinator@example.com' /></div>
          <div><label>Venue</label><select id='invVenue'><option value=''>-- select --</option>${venueOptions}</select></div>
          <div><label>With Additional Services?</label><select id='invService'><option value='no'>No</option><option value='yes'>Yes</option></select></div>
          <div><label>Date</label><input id='invDate' type='date' value='${new Date().toISOString().slice(0,10)}' /></div>
          <div><label>Invoice No</label><input id='invNo' readonly value='${generateInvoiceNo()}' /></div>
        </div>
        <div style='display:flex;gap:8px;margin-top:12px;align-items:center'><button id='calcCost' class='btn ghost'>Calculate</button><div class='muted'>Amount: <b id='calcAmount'>GHS 0.00</b></div></div>
        <div style='margin-top:12px;text-align:right'><button id='saveInvoice' class='btn'>Save & Preview</button></div>
      `;
      const modal = openModal(html);

      modal.querySelector('#invInst').addEventListener('change', function(){
        const inst = institutions.find(i=>i.id==this.value); if(inst) modal.querySelector('#invEmail').value = inst.email||'';
      });

      modal.querySelector('#calcCost').addEventListener('click', ()=>{
        const venueName = modal.querySelector('#invVenue').value; const want = modal.querySelector('#invService').value==='yes';
        const v = venues.find(vv=>vv.name===venueName);
        const amt = v ? (want? v.withServices: v.base) : 0;
        modal.querySelector('#calcAmount').textContent = 'GHS ' + fmt(amt);
      });

      modal.querySelector('#saveInvoice').addEventListener('click', ()=>{
        const instId = Number(modal.querySelector('#invInst').value)||null;
        const email = modal.querySelector('#invEmail').value.trim();
        const venue = modal.querySelector('#invVenue').value;
        const want = modal.querySelector('#invService').value==='yes';
        const v = venues.find(vv=>vv.name===venue);
        const amount = v ? (want? v.withServices: v.base) : 0;
        const date = modal.querySelector('#invDate').value;
        const invoiceNo = modal.querySelector('#invNo').value;
        const id = Date.now();
        invoices.push({id, invoiceNo, institutionId:instId, institution: instId? null : 'Manual', coordinatorEmail:email, venue, amount, date, status:'Pending'});
        persist();
        // open preview
        openInvoicePreview(id);
        document.querySelector('#modalRoot').innerHTML='';
      });
    }

    /*******************************
     * Preview + download invoice (simple template)
     *******************************/
    function openInvoicePreview(invId){
      const inv = invoices.find(i=>i.id===invId);
      const inst = institutions.find(i=>i.id===inv.institutionId) || {name:inv.institution||'Manual'};
      const html = `
        <div id='invoicePreview'>
          <div style='display:flex;justify-content:space-between;align-items:center'><div><h2>GTEC HOSPITALITY MANAGEMENT SERVICES</h2><div>P.O.BOX MB 28, MINISTRIES ‚Äì ACCRA</div></div><div style='text-align:right'><div><b>Invoice No:</b> ${inv.invoiceNo}</div><div><b>Date:</b> ${inv.date}</div></div></div>
          <hr style='margin:12px 0' />
          <div style='display:flex;justify-content:space-between'><div><b>Coordinator:</b> ${inst.name}</div><div><b>Email:</b> ${inv.coordinatorEmail||''}</div></div>
          <div style='margin-top:12px'>
            <table style='width:100%;border-collapse:collapse' border='1'><thead><tr><th>SI No</th><th>Description</th><th>Amount</th></tr></thead><tbody><tr><td>1</td><td>${inv.venue}</td><td>GHS ${fmt(inv.amount)}</td></tr><tr><td colspan='2' style='text-align:right'><b>TOTAL</b></td><td><b>GHS ${fmt(inv.amount)}</b></td></tr></tbody></table>
          </div>
          <div style='margin-top:20px;text-align:right'><button id='dlPdf' class='btn'>Download PDF</button></div>
        </div>
      `;
      const modal = openModal(html);
      modal.querySelector('#dlPdf').addEventListener('click', ()=>{
        const opt = {filename:`${inv.invoiceNo}.pdf`,jsPDF:{unit:'pt',format:'a4'}};
        html2pdf().from(modal.querySelector('#invoicePreview')).set(opt).save();
      });
    }

    document.addEventListener('click', (e)=>{
      if(e.target.classList.contains('previewInv')){ const id = Number(e.target.dataset.id); openInvoicePreview(id); }
      if(e.target.dataset.action==='download'){ const id = Number(e.target.dataset.id); openInvoicePreview(id); }
    });

    /*******************************
     * Live stats fetch from Google Apps Script Web App
     *******************************/
    const LIVE_STATS_URL = "https://script.google.com/macros/s/AKfycbzXyA69pX8nMGJjpVm-XFo4Vbk-w0CSBeN6-Y0uQQtEKKoZatbV8KisJLqMcKtyeZx4/exec";

    async function fetchLiveStats(){
      try {
        const res = await fetch(LIVE_STATS_URL, {cache: "no-store"});
        if(!res.ok){
          console.warn("Live stats fetch failed:", res.status);
          return;
        }
        const data = await res.json();
        // expected structure: {"Pending":10,"Cancelled":4,"Completed":16}
        if(typeof data === 'object' && data !== null){
          const pending = data.Pending || 0;
const cancelled = data.Cancelled || 0;
const completed = data.Completed || 0;

qs('#dashPending').textContent = pending;
qs('#dashCancelled').textContent = cancelled;
qs('#dashCompleted').textContent = completed;

// update total bookings as sum of the three
qs('#dashBookings').textContent = pending + cancelled + completed;
qs('#statBookings').textContent = pending + cancelled + completed;
qs('#reportBookings').textContent = pending + cancelled + completed;

// optional: keep reportPending updated

qs('#reportPending').textContent = pending;


          
        }
      } catch (err){
        console.error("Error fetching live stats:", err);
      }
    }

    /*******************************
     * Init
     *******************************/
    document.addEventListener('DOMContentLoaded', ()=>{
      updateUI(); showPage('dashboard');
      // fetch live stats immediately and then every 30s
      fetchLiveStats();
      setInterval(fetchLiveStats, 30000);
    });

  </script>


  
  <!-- Fetch email subscription of news letters -->
<script>
const db = firebase.firestore();

function loadSubscriptions() {
  const tbody = document.querySelector("#subscriptionsTable tbody");

  db.collection("subscriptions")
    .orderBy("createdAt", "desc")
    .onSnapshot(snapshot => {
      tbody.innerHTML = ""; // clear table
      let index = 1;

      snapshot.forEach(doc => {
        const data = doc.data();
        const date = data.createdAt ? data.createdAt.toDate().toLocaleString() : "Unknown";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index++}</td>
          <td>${data.email}</td>
          <td>${date}</td>
          <td><button class="delete-btn" data-id="${doc.id}">Delete</button></td>
        `;
        tbody.appendChild(tr);
      });

      // Delete button
      tbody.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const docId = btn.dataset.id;
          if (confirm("Are you sure you want to delete this subscriber?")) {
            try {
              await db.collection("subscriptions").doc(docId).delete();
              btn.closest("tr").remove();
            } catch (err) {
              console.error("Delete error:", err);
              alert("Failed to delete subscriber.");
            }
          }
        });
      });
    }, err => console.error("Firestore error:", err));
}

document.addEventListener("DOMContentLoaded", loadSubscriptions);
</script>

<script>
document.getElementById("subscribeForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const email = this.email.value.trim().toLowerCase();
  const msg = document.getElementById("subscribeMessage");

  if (!email) return;

  try {
    // üîí CHECK IF EMAIL ALREADY EXISTS
    const existing = await db
      .collection("subscriptions")
      .where("email", "==", email)
      .get();

    if (!existing.empty) {
      msg.style.display = "block";
      msg.style.color = "orange";
      msg.textContent = "This email is already subscribed.";
      return;
    }

    // ADD NEW SUBSCRIPTION
    await db.collection("subscriptions").add({
      email: email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    msg.style.display = "block";
    msg.style.color = "green";
    msg.textContent = "Subscribed successfully!";

    this.reset();

    setTimeout(() => msg.style.display = "none", 3000);

  } catch (error) {
    console.error("Subscription error:", error);
    msg.style.display = "block";
    msg.style.color = "red";
    msg.textContent = "Failed to subscribe. Please try again.";
  }
});
</script>

<!-- Contact Message)-->
<script>
  function loadContactMessages() {
  const tbody = document.querySelector("#contactMessagesTable tbody");
  tbody.innerHTML = "";

  db.collection("contactMessages")
    .orderBy("createdAt", "desc")
    .onSnapshot(snapshot => {
      tbody.innerHTML = "";
      let index = 1;

      snapshot.forEach(doc => {
        const data = doc.data();
        const date = data.createdAt ? data.createdAt.toDate().toLocaleString() : "";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index++}</td>
          <td>${data.name}</td>
          <td>${data.email}</td>
          <td>${data.message}</td>
          <td>${date}</td>
          <td><button class="delete-btn" data-id="${doc.id}">Delete</button></td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const docId = btn.dataset.id;
          if (confirm("Are you sure you want to delete this message?")) {
            try {
              await db.collection("contactMessages").doc(docId).delete();
              btn.closest("tr").remove();
            } catch (err) {
              console.error("Delete error:", err);
              alert("Failed to delete message.");
            }
          }
        });
      });
    });
}

document.addEventListener("DOMContentLoaded", loadContactMessages);

</script>
  

<!-- TimeOut LogOut Session -->

<script>
let inactivityTimer;

// Time in milliseconds (5 minutes)
const LOGOUT_TIME = 5 * 60 * 1000;

// Function to sign out the user
function autoLogout() {
  alert("You have been logged out due to inactivity.");
  firebase.auth().signOut().then(() => {
    window.location.href = "index.html"; // redirect to login
  });
}

// Reset the inactivity timer
function resetTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(autoLogout, LOGOUT_TIME);
}

// List of events considered as activity
["mousemove", "keydown", "mousedown", "touchstart", "click"].forEach(event => {
  document.addEventListener(event, resetTimer);
});

// Start the timer when page loads
resetTimer();
</script>


<!-- Red Dot on Contact Messages -->
  <script>
  // Reference to button and dot
const messagesBtn = document.getElementById('messagesBtn');
const newMessageDot = document.getElementById('newMessageDot');

// Listen for new contact messages in Firestore
db.collection('contactMessages')
  .orderBy('createdAt', 'desc')
  .limit(1)
  .onSnapshot(snapshot => {
    snapshot.docChanges().forEach(change => {
      if (change.type === 'added') {
        // Show the red dot when a new message is added
        newMessageDot.style.display = 'inline-block';
      }
    });
  });

// Optional: hide dot when button is clicked
messagesBtn.addEventListener('click', () => {
  newMessageDot.style.display = 'none';
});
  </script>

  
  
  
<!-- Logged In As User/Admin (Email)-->
<script>
firebase.auth().onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  // Show logged-in email
  document.getElementById("loggedInUser").textContent = user.email;
});
</script>


    <script>
    const sheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR9htPtAQjzUItZtpzGxl71AVEqki52Kj6hqbxcenA1wEwQt0wuH5yB6gkv0Mx_UQki_MLnS5ZBRuey/pub?gid=201909864&single=true&output=csv";
    let entries = [];

    // Peek next invoice number WITHOUT incrementing stored counter
    function peekNextInvoiceNo() {
      const prefix = "GTEC-HMS";
      const year = new Date().getFullYear().toString().slice(-2);
      let lastNumber = parseInt(localStorage.getItem("lastInvoiceNumber") || "0", 10);
      let nextNumber = lastNumber + 1;
      const invoiceNumber = String(nextNumber).padStart(3, "0");
      return `${prefix}-${year}-${invoiceNumber}`;
    }

    // Generate (and reserve) next invoice number (increments stored counter)
    function generateInvoiceNo() {
      const prefix = "GTEC-HMS";
      const year = new Date().getFullYear().toString().slice(-2);
      let lastNumber = parseInt(localStorage.getItem("lastInvoiceNumber") || "0", 10);
      lastNumber = lastNumber + 1;
      localStorage.setItem("lastInvoiceNumber", String(lastNumber));
      const invoiceNumber = String(lastNumber).padStart(3, "0");
      return `${prefix}-${year}-${invoiceNumber}`;
    }

    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const res = await fetch(sheetCSV);
        if (!res.ok) throw new Error("Failed to fetch CSV");
        const csvText = await res.text();

        const rows = csvText.trim().split("\n").map(r => r.split(","));
        const headers = rows[0].map(h => h.trim().toLowerCase());

        entries = rows.slice(1).map(r => {
          const obj = {};
          headers.forEach((h, i) => {
            obj[h] = r[i] ? r[i].trim() : "";
          });
          return obj;
        });

        populateInstitutions();
        populateRecipients();
      } catch (err) {
        console.error("Error:", err);
        // Graceful fallback: still call populate functions
        populateInstitutions();
        populateRecipients();
      }

      // Set suggested invoice number in the form (editable) but don't reserve it yet.
      const suggested = peekNextInvoiceNo();
      document.getElementById("invoiceId").value = suggested;
      // Show suggestion also in preview input so user sees it ‚Äî still editable
      document.getElementById("invoiceNo").value = suggested;
    });

    function populateRecipients() {
      // defensive: ensure datalists exist
      const nameList = document.getElementById("recipientNameList");
      const emailList = document.getElementById("recipientEmailList");
      if (!nameList || !emailList) return;

      const nameSet = new Set(entries.map(e => e["recipient name"]).filter(Boolean));
      const emailSet = new Set(entries.map(e => e["recipient email"]).filter(Boolean));
      nameList.innerHTML = "";
      emailList.innerHTML = "";
      nameSet.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        nameList.appendChild(opt);
      });
      emailSet.forEach(email => {
        const opt = document.createElement("option");
        opt.value = email;
        emailList.appendChild(opt);
      });
    }

    // keep recipient name/email auto-linking
    document.getElementById("recipientName").addEventListener("input", function () {
      const name = this.value;
      const match = entries.find(e => e["recipient name"] === name);
      if (match) {
        document.getElementById("recipientEmail").value = match["recipient email"] || "";
      }
    });

    document.getElementById("recipientEmail").addEventListener("input", function () {
      const email = this.value;
      const match = entries.find(e => e["recipient email"] === email);
      if (match) {
        document.getElementById("recipientName").value = match["recipient name"] || "";
      }
    });

    // Fixed venueCosts - numbers must be numeric (no commas)
    const venueCosts = {
      "Effah Hall (Full Auditorium) - With Additional Services": 14000,
      "Effah Hall (Full Auditorium) - No Additional Services": 12000,
      "Effah Hall (Ground Floor) - With Additional Services": 12000,
      "Effah Hall (Ground Floor) - No Additional Services": 10000,
      "Ahmed Jinapor Hall": 5000,
      "Kwame Dattey Hall": 3500,
      "Nikoi Kotey Hall": 2500
    };

    document.getElementById("venueCostSelect").addEventListener("change", function () {
      const selectedVenue = this.value;
      const costInput = document.getElementById("venueCostInput");
      if (venueCosts[selectedVenue] !== undefined) {
        costInput.value = Number(venueCosts[selectedVenue]).toFixed(2);
      } else {
        costInput.value = "";
      }
    });

    function populateInstitutions() {
      const instSet = new Set(entries.map(e => e["name of institution"]).filter(Boolean));
      const instSelect = document.getElementById("institutionSelect");
      if (!instSelect) return;
      instSelect.innerHTML = '<option value="">-- Select Institution --</option>';
      instSet.forEach(inst => {
        const opt = document.createElement("option");
        opt.value = inst;
        opt.textContent = inst;
        instSelect.appendChild(opt);
      });
      instSelect.onchange = onInstitutionChange;
    }

    function onInstitutionChange() {
      const inst = document.getElementById("institutionSelect").value;
      const venueSelect = document.getElementById("venueSelect");
      venueSelect.innerHTML = '<option value="">-- Select Venue --</option>';
      if (!inst) {
        venueSelect.disabled = true;
        return;
      }
      const filtered = entries.filter(e => e["name of institution"] === inst);
      if (filtered.length > 0) {
        document.getElementById("recipientName").value = filtered[0]["recipient name"] || "";
        document.getElementById("recipientEmail").value = filtered[0]["recipient email"] || "";
      }
      filtered.forEach(e => {
        const vOpt = document.createElement("option");
        vOpt.value = e["venue booked"];
        vOpt.textContent = e["venue booked"];
        venueSelect.appendChild(vOpt);
      });
      venueSelect.disabled = false;
    }

    function generateInvoice() {
      const venue = document.getElementById("venueSelect").value;
      const service = document.getElementById("serviceInput").value.trim();
      const recipientName = document.getElementById("recipientName").value.trim();
      const invoiceLocation = document.getElementById("invoiceLocation").value;
      const recipientEmail = document.getElementById("recipientEmail").value.trim();
      let chosenInvoiceNo = document.getElementById("invoiceId").value.trim();
      const dateVal = document.getElementById("dated").value || new Date().toLocaleDateString();
      const venueCost = parseFloat(document.getElementById("venueCostInput").value) || 0;

      // If user left invoiceId empty, or it equals the peek suggestion, reserve the next numbered invoice.
      const suggested = peekNextInvoiceNo();
      if (!chosenInvoiceNo || chosenInvoiceNo === suggested) {
        // This will increment and reserve the next number
        chosenInvoiceNo = generateInvoiceNo();
        document.getElementById("invoiceId").value = chosenInvoiceNo;
      }
      // Otherwise we assume user provided a custom invoice id ‚Äî do not increment stored counter

      // show chosen invoice number in preview input
      document.getElementById("invoiceNo").value = chosenInvoiceNo;
      document.getElementById("invoiceId").value = chosenInvoiceNo;
      document.getElementById("invDate").textContent = dateVal;

      // Recipient
      document.getElementById("billToName").textContent = recipientName;
      document.getElementById("billToLocation").textContent = invoiceLocation || "";
      document.getElementById("billToEmail").textContent = recipientEmail;

      // Build items
      let items = [];
      if (venue) items.push({ desc: venue, amount: venueCost });
      if (service === "Additional Services") {
        items.push({ desc: service, amount: "" }); // empty instead of 0.00
      }

      // Calculate total only from numeric amounts
      let totalCost = items.reduce((sum, item) => sum + (typeof item.amount === "number" ? item.amount : 0), 0);

      // Build rows
      let rowsHTML = "";
      if (venue) {
        rowsHTML += `
          <tr>
            <td>1</td>
            <td>
              ${venue}
              ${service === "Additional Services" ? "<br><span style='font-style:italic;'>Additional Services</span>" : ""}
            </td>
            <td>${venueCost.toFixed(2)}</td>
          </tr>
        `;
      }

      rowsHTML += `
        <tr>
          <td colspan="2" style="text-align:right;"><b>TOTAL</b></td>
          <td>${totalCost.toFixed(2)}</td>
        </tr>
      `;

      document.getElementById("itemsTable").innerHTML = `
        <tr>
          <th style="width:10%;">SI No.</th>
          <th style="width:70%;">DESCRIPTION</th>
          <th style="width:20%;">AMOUNT</th>
        </tr>
        ${rowsHTML}
      `;

      // Show total in left form too 
      document.getElementById("totalInput").value = totalCost.toFixed(2);

      document.getElementById("invoice").style.display = "block";
      document.getElementById("downloadBtn").style.display = "inline-block";

      const signatureText = document.getElementById("signatureName").value.trim();
      document.getElementById("signatureDisplay").textContent = signatureText;

      // Save invoice to history (use chosenInvoiceNo)
      saveInvoiceToHistory({
        number: chosenInvoiceNo,
        institution: document.getElementById("institutionSelect").value || "N/A",
        venue: venue,
        recipient: recipientName,
        location: invoiceLocation,
        total: totalCost.toFixed(2),
        date: dateVal,
        signature: signatureText
      });
    }

    
    // attach download handler (button exists in DOM)
document.getElementById("downloadBtn").addEventListener("click", () => {
  const institution = document.getElementById("institutionSelect").value || "Institution";
  const invoiceNo = document.getElementById("invoiceNo").value || "INV";
  const today = new Date();
  const dateStr = today.getFullYear() + "-" +
                  String(today.getMonth() + 1).padStart(2, "0") + "-" +
                  String(today.getDate()).padStart(2, "0");

  const fileName = `GTEC_Invoice_${invoiceNo}_${institution}_${dateStr}.pdf`
                    .replace(/\s+/g, "_");

  const invoiceElem = document.getElementById("invoice");

  // 1Ô∏è‚É£ Generate PDF as base64
  html2pdf()
    .from(invoiceElem)
    .outputPdf("datauristring")
    .then(pdfDataUri => {
      const base64 = pdfDataUri.split(",")[1];

      // 2Ô∏è‚É£ Download to user's device (same as before)
      html2pdf().from(invoiceElem).save(fileName);

      // 3Ô∏è‚É£ Upload to Google Drive (background)
      fetch("https://script.google.com/macros/s/AKfycbxcJLWeemy7PRYliGDHeSYa7BCIlOUsVzuAHFCvQIKQ8U_R2QkxneVQqNV6b_EgFj5k/exec", {
  method: "POST",
  mode: "no-cors",
  body: JSON.stringify({
    pdf: base64,
    fileName: fileName,
    invoiceNo: invoiceNo,
    institution: institution
  })
})
.then(() => {
  console.log("Drive upload sent ‚úî");
})
.catch(err => {
  console.error("Drive upload failed ‚ùå", err);
});

    });
});

    

    // Save invoice record to localStorage
    function saveInvoiceToHistory(invoice) {
      const history = JSON.parse(localStorage.getItem("invoiceHistory")) || [];
      history.push(invoice);
      localStorage.setItem("invoiceHistory", JSON.stringify(history));
    }

    // --- Open / Close modal ---
    function openHistoryModal() {
      populateModalInvoiceHistory();
      const modal = document.getElementById("historyModal");
      modal.style.display = "block";
      modal.setAttribute("aria-hidden", "false");
    }
    function closeHistoryModal() {
      const modal = document.getElementById("historyModal");
      modal.style.display = "none";
      modal.setAttribute("aria-hidden", "true");
    }
    document.getElementById("closeModalBtn").addEventListener("click", closeHistoryModal);
    document.getElementById("historyModal").addEventListener("click", e => {
      if (e.target === e.currentTarget) closeHistoryModal();
    });

    // --- Populate table with localStorage invoices ---
    function populateModalInvoiceHistory() {
      const history = JSON.parse(localStorage.getItem("invoiceHistory")) || [];
      const tbody = document.querySelector("#modalInvoiceTable tbody");
      tbody.innerHTML = "";

      if (history.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:18px;">No invoices found</td></tr>`;
        return;
      }

      history.slice().reverse().forEach((inv, idx) => {
        const row = document.createElement("tr");
        const status = "Completed"; // static, can extend later
        row.innerHTML = `
          <td>${inv.number}</td>
          <td>${inv.date}</td>
          <td>${inv.total}</td>
          <td>${inv.recipient}</td>
          <td>${status}</td>
          <td>
            <button class="view-btn-sm" onclick="viewInvoiceFromHistory('${inv.number}')">View</button>
            <button class="download-btn-sm" onclick="downloadInvoiceFromHistory('${inv.number}')">Download</button>
          </td>`;
        tbody.appendChild(row);
      });
    }

    // --- Clear history ---
    document.getElementById("clearHistoryBtn").addEventListener("click", () => {
      if (!confirm("Clear all saved invoice history? This cannot be undone.")) return;
      localStorage.removeItem("invoiceHistory");
      populateModalInvoiceHistory();
    });

    // --- Reopen a saved invoice preview ---
    function viewInvoiceFromHistory(invNumber) {
      const history = JSON.parse(localStorage.getItem("invoiceHistory")) || [];
      const invoice = history.find(h => h.number === invNumber);
      if (!invoice) return alert("Invoice not found.");
      closeHistoryModal();

      // Restore basic data to preview area and to form so user can edit if needed
      document.getElementById("invoice").style.display = "block";
      document.getElementById("downloadBtn").style.display = "inline-block";

      // Put invoice number into both preview input and form input
      document.getElementById("invoiceNo").value = invoice.number;
      document.getElementById("invoiceId").value = invoice.number;

      document.getElementById("invDate").textContent = invoice.date;
      document.getElementById("billToName").textContent = invoice.recipient;
      document.getElementById("billToLocation").textContent = invoice.location || "";
      document.getElementById("billToEmail").textContent = ""; // optional if stored later
      document.getElementById("signatureDisplay").textContent = invoice.signature || "";

      document.getElementById("itemsTable").innerHTML = `
        <tr><th>SI No.</th><th>DESCRIPTION</th><th>AMOUNT</th></tr>
        <tr><td>1</td><td>${invoice.venue}</td><td>${invoice.total}</td></tr>
        <tr><td colspan="2" style="text-align:right;"><b>TOTAL</b></td>
            <td><b>${invoice.total}</b></td></tr>`;
    }

    // --- Direct download from modal ---
    function downloadInvoiceFromHistory(invNumber) {
      const history = JSON.parse(localStorage.getItem("invoiceHistory")) || [];
      const invoice = history.find(h => h.number === invNumber);
      if (!invoice) return alert("Invoice not found.");

      // Reopen preview (so invoice DOM is filled) then export
      viewInvoiceFromHistory(invNumber);
      const invoiceElem = document.getElementById("invoice");
      const fileName = `GTEC_Invoice_${invoice.number}.pdf`;
      html2pdf().from(invoiceElem).save(fileName);
    }

    // --- Signature sync (live update) ---
    document.getElementById("signatureName").addEventListener("input", function() {
      document.getElementById("signatureDisplay").textContent = this.value;
    });

  </script>


    <script>
const menuToggle = document.getElementById("menuToggle");
const mobileNav = document.getElementById("mobileNav");

menuToggle.addEventListener("click", () => {
  mobileNav.classList.toggle("show");
  menuToggle.textContent = mobileNav.classList.contains("show") ? "‚úï" : "‚ò∞";
});
</script>

  

  <style>
    /* =========================
   INVOICE POPUP MODAL
   ========================= */

.invoices-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.add-btn {
  padding: 10px 16px;
  border-radius: 6px;
  border: none;
  background: #007bff;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
}

.invoice-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  z-index: 4000;
}

.invoice-modal-content {
  background: #fff;
  width: 95%;
  max-width: 1400px;
  height: 90vh;
  margin: 3vh auto;
  border-radius: 10px;
  position: relative;
  overflow: hidden;
}

.invoice-close {
  position: absolute;
  top: 12px;
  right: 16px;
  font-size: 26px;
  background: transparent;
  border: none;
  cursor: pointer;
  z-index: 10;
}

/* OVERRIDE FULL PAGE */
.invoice-modal .container {
  display: flex;
  height: 100%;
}

.invoice-modal .form-section,
.invoice-modal .preview-section {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}

/* PREVIEW SCALE */
.invoice-modal #invoice {
  width: 794px;
  transform: scale(0.72);
  transform-origin: top center;
  background: #fff;
  box-shadow: 0 8px 24px rgba(0,0,0,.15);
}

  </style>


<script>

  const openInvoicePopup = document.getElementById("openInvoicePopup");
const closeInvoicePopup = document.getElementById("closeInvoicePopup");
const invoicePopup = document.getElementById("invoicePopup");

openInvoicePopup.onclick = () => {
  invoicePopup.style.display = "block";
  document.body.style.overflow = "hidden";
};

closeInvoicePopup.onclick = () => {
  invoicePopup.style.display = "none";
  document.body.style.overflow = "";
};

invoicePopup.addEventListener("click", e => {
  if (e.target === invoicePopup) {
    invoicePopup.style.display = "none";
    document.body.style.overflow = "";
  }
});

</script>



  
</body>
</html>

















