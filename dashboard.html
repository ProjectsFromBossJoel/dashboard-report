<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  
  <title>GTEC Conference Facility ‚Äî Admin Dashboard</title>
  <link rel="icon" type="image/png" href="favicon.png">

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
import { auth, onAuthStateChanged, signOut } from "./firebase.js";

onAuthStateChanged(auth, (user) => {
    if (!user || !user.emailVerified) {
        window.location.href = "login.html";
    }
});

document.getElementById("logoutBtn").addEventListener("click", () => {
    signOut(auth).then(() => {
        window.location.href = "login.html";
    });
});
</script>

  <style>
    :root{
      --bg:#f4f7fb; --card:#ffffff; --muted:#6b7280; --primary:#2563eb; --accent:#0ea5a4; --danger:#ef4444;
      --glass: rgba(255,255,255,0.7);
      --radius:12px;
      --shadow: 0 6px 18px rgba(31,41,55,0.08);
      --sidebar-w:260px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#f8fbff, #f4f7fb);min-height:100vh;color:#0f172a}
    .app{display:flex;gap:20px;min-height:100vh;padding:24px}

    /* Sidebar */
    .sidebar{width:var(--sidebar-w);background:linear-gradient(180deg,var(--card),#f8fafc);border-radius:14px;padding:20px;box-shadow:var(--shadow);flex-shrink:0}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    .brand h1{font-size:16px;margin:0}
    .nav{margin-top:14px}
    .nav button{display:flex;align-items:center;gap:10px;width:100%;padding:10px;border-radius:10px;border:none;background:transparent;color:#0f172a;cursor:pointer;text-align:left;font-weight:600}
    .nav button.active{background:linear-gradient(90deg,rgba(37,99,235,0.12),rgba(14,165,164,0.06));color:var(--primary)}
    .nav .small{font-size:12px;color:var(--muted);font-weight:500}
    .sidebar .quick{margin-top:22px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fbfcff,#fff);box-shadow:inset 0 1px 0 rgba(255,255,255,0.6)}
    .stat{display:flex;justify-content:space-between;gap:8px;margin-bottom:8px}
    .stat .val{font-weight:800}

    /* Main area */
    .main{flex:1}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px}
    .search{flex:1;display:flex;gap:8px}
    .search input{flex:1;padding:10px;border-radius:10px;border:1px solid #e6edf3}
    .actions{display:flex;gap:8px}
    .btn{padding:10px 12px;border-radius:10px;border:none;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(37,99,235,0.12)}

    .card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #eef3f7;text-align:left}
    .table th{background:transparent;color:var(--muted);font-weight:700}
    .table tr:hover td{background:#fbfdff}

    /* Stat cards on dashboard: use 4 across */
    .dashboard-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}

    /* colored stat cards */
    .stat-card{border-radius:12px;padding:18px;color:#0f172a;transition:transform .18s ease,box-shadow .18s ease}
    .stat-card:hover{transform:translateY(-6px);box-shadow:0 14px 40px rgba(31,41,55,0.12)}
    .stat-card .small{opacity:0.9}
    .stat-card h2{margin:6px 0 0;font-size:28px}

    .stat-red{background:linear-gradient(180deg,#fff5f5,#fff);border:1px solid rgba(239,68,68,0.08)}
    .stat-red .label-pill{background:#fee2e2;color:#b91c1c;border-radius:999px;padding:6px 10px;font-weight:700}

    .stat-ash{background:linear-gradient(180deg,#f6f6f7,#fff);border:1px solid rgba(15,23,42,0.03)}
    .stat-ash .label-pill{background:#f3f4f6;color:#374151;border-radius:999px;padding:6px 10px;font-weight:700}

    .stat-green{background:linear-gradient(180deg,#f0fdf4,#fff);border:1px solid rgba(16,185,129,0.06)}
    .stat-green .label-pill{background:#dcfce7;color:#065f46;border-radius:999px;padding:6px 10px;font-weight:700}

    /* Forms & modal */
    .form-row{display:flex;gap:10px}
    label{font-size:13px;color:var(--muted)}
    input,select{padding:10px;border-radius:8px;border:1px solid #e6edf3;width:100%}

    .right-actions{display:flex;gap:8px;align-items:center}
    .pill{padding:6px 10px;border-radius:999px;background:#eff6ff;color:var(--primary);font-weight:700;font-size:13px}

    footer{margin-top:20px;text-align:center;color:var(--muted);font-size:13px}

    /* Responsive */
    @media (max-width:1000px){.dashboard-cards{grid-template-columns:repeat(1,1fr)} .grid{grid-template-columns:repeat(1,1fr)} .sidebar{display:none} .app{padding:12px}}

    /* small helpers */
    .muted{color:var(--muted)}
    .right{float:right}
    .flex{display:flex;align-items:center;gap:10px}

    /* custom invoice preview styling */
    #invoicePreview{max-width:800px;margin:0 auto}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="app">


    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
  <img src="logo1.jpg" alt="GTEC Logo" class="logo" style="height:50px; width:auto;">
<div><h1>GTEC Conference</h1><div class="small muted">Facility Management</div></div></div>

      <div class="nav" role="navigation">
        <button class="active" data-page="dashboard">üè† Dashboard</button>
        <button data-page="institutions">üè´ Institutions</button>
        <button data-page="venues">üìç Venues</button>
        <button data-page="invoices">üßæ Invoices</button>
        <button data-page="users">üë• Users & Roles</button>
        <button data-page="reports">üìä Reports</button>
        <button data-page="settings">‚öôÔ∏è Settings</button>
      </div>

      <div class="quick">
        <div class="stat"><div><div class="small muted">Bookings</div><div class="val" id="statBookings">0</div></div><div class="pill">Live</div></div>
        <div class="stat"><div><div class="small muted">Revenue</div><div class="val" id="statRevenue">GHS 0</div></div><div class="pill">‚Çµ</div></div>
        <div class="stat"><div><div class="small muted">Pending</div><div class="val" id="statPending">0</div></div><div class="pill">!</div></div>
      </div>

      <div style="margin-top:12px;font-size:13px;color:var(--muted);">Logged in as <b>User</b></div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar">
        <div class="search">
          <input id="globalSearch" placeholder="Search institutions, invoices, venues..." />
          <div class="right-actions">
            <button class="btn ghost" id="btnExport">Export CSV</button>
            <button class="btn" id="btnNewBooking">+ New Booking</button>
          </div>
          <button id="logoutBtn">Logout</button>
        </div>
        <div class="flex">
          <div style="text-align:right"><div class="muted">Today</div><div style="font-weight:800"> <span id="todayDate"></span></div></div>
        </div>
      </div>

      <!-- PAGES -->

      <section id="dashboard" class="page">
        <!-- Dashboard stat cards: 4 cards -->
        <div class="dashboard-cards">
          <div class="card stat-card">
            <div class="small muted">Total Bookings</div>
            <h2 id="dashBookings">0</h2>
            <div class="muted">Bookings by venue below</div>
          </div>

          <div class="card stat-card stat-red">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="small muted">Pending</div>
              <div class="label-pill">üî¥ Pending</div>
            </div>
            <h2 id="dashPending">0</h2>
            <div class="muted">Awaiting events</div>
          </div>

          <div class="card stat-card stat-ash">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="small muted">Cancelled</div>
              <div class="label-pill">‚ö™ Cancelled</div>
            </div>
            <h2 id="dashCancelled">0</h2>
            <div class="muted">Bookings cancelled</div>
          </div>

          <div class="card stat-card stat-green">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="small muted">Completed</div>
              <div class="label-pill">üü¢ Completed</div>
            </div>
            <h2 id="dashCompleted">0</h2>
            <div class="muted">Successfully completed</div>
          </div>
        </div>

        <div class="card" style="margin-bottom:12px">
          <canvas id="venueChart" height="90"></canvas>
        </div>

        <div class="card">
          <h3 style="margin-top:0">Recent Invoices</h3>
          <table class="table" id="recentInvoicesTable"><thead><tr><th>Invoice</th><th>Coordinator</th><th>Venue</th><th>Amount</th><th>Status</th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <section id="institutions" class="page hidden">
        <div class="card" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 style="margin:0">Institutions</h3>
          <div><button class="btn ghost" id="btnImportCSV">Import CSV</button> <button class="btn" id="btnAddInstitution">+ Add Institution</button></div>
        </div>
        <div class="card">
          <div style="overflow-x:auto; overflow-y:auto; max-height:500px; border:1px solid #ccc; padding:5px;">
          <table class="table" id="institutionsTable">
  <thead>
    <tr>
      <th>Timestamp</th>
      <th>Name of Applicant</th>
      <th>Name of Institution/Organization/Person</th>
      <th>Number of Participants</th>
      <th>Venue</th>
      <th>Event Description</th>
      <th>Event Start Date</th>
      <th>Event End Date</th>
      <th>Additional Services</th>
      <th>Time Event Starts (AM/PM)</th>
      <th>Time Event Ends (AM/PM)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
          </div>

        </div>
      </section>

      <section id="venues" class="page hidden">
        <div class="card" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 style="margin:0">Venues & Pricing</h3>
          <div><button class="btn" id="btnAddVenue">+ Add Venue</button></div>
        </div>
        <div class="card">
          <table class="table" id="venuesTable"><thead><tr><th>Venue</th><th>Default Cost</th><th>With Services</th><th>Action</th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <section id="invoices" class="page hidden">
        <div class="card" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 style="margin:0">Invoices</h3>
          <div><button class="btn" id="btnGenerateInvoice">+ Generate</button></div>
        </div>
        <div class="card">
          <table class="table" id="invoicesTable"><thead><tr><th>Invoice #</th><th>Coordinator</th><th>Venue</th><th>Amount</th><th>Date</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <section id="users" class="page hidden">
        <div class="card" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 style="margin:0">Users & Roles</h3>
          <div><button class="btn" id="btnAddUser">+ Add User</button></div>
        </div>
        <div class="card">
          <table class="table" id="usersTable"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Action</th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <section id="reports" class="page hidden">
        <div class="card">
          <h3>Reports</h3>
          <p class="muted">Quick revenue and booking exports</p>
          <div style="display:flex;gap:12px;margin-top:12px">
            <div style="flex:1" class="card"><b>Total Revenue</b><div id="reportRevenue">GHS 0</div></div>
            <div style="flex:1" class="card"><b>Bookings Count</b><div id="reportBookings">0</div></div>
            <div style="flex:1" class="card"><b>Pending</b><div id="reportPending">0</div></div>
          </div>
        </div>
      </section>

      <section id="settings" class="page hidden">
        <div class="card">
          <h3>Settings</h3>
          <p class="muted">Local demo settings (stored in browser). Connect to your backend to persist.</p>
          <div style="margin-top:12px">
            <label>Organization Name</label>
            <input id="orgName" placeholder="GTEC Conference" />
            <div style="height:12px"></div>
            <label>Default Currency</label>
            <input id="orgCurrency" placeholder="GHS" />
          </div>
        </div>
      </section>

      <footer>GTEC Conference Facility Dashboard - 2025</footer>
    </main>
  </div>

  <!-- MODALS (hidden) -->
  <div id="modalRoot"></div>

  <script>
// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyA80t2tr136ihN57YQWwD4nYcPhyutACX4",
  authDomain: "userlogin-44d0a.firebaseapp.com",
  projectId: "userlogin-44d0a",
  storageBucket: "userlogin-44d0a.firebasestorage.app",
  messagingSenderId: "47108256134",
  appId: "1:47108256134:web:60888fa5f06dfb075d3c07",
  measurementId: "G-ZCVWTTFT2H"
};
    
firebase.initializeApp(firebaseConfig);

firebase.auth().onAuthStateChanged(user => {
  if (!user) window.location.href = "index.html";
});

function logout() {
  firebase.auth().signOut().then(() => {
    window.location.href = "index.html";
  });
}

</script>

  

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
  const sheetCSVUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLDl2oNe9mONdejXYfXqk3hjdVZUWHsfdN47F54BS4nyufgxV_o2VaCm-upReu1ERhZZQ173TfDJ3B/pub?gid=2055986518&single=true&output=csv";

  function loadInstitutions() {
    Papa.parse(sheetCSVUrl, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const data = results.data;
        const tbody = document.querySelector("#institutionsTable tbody");
        tbody.innerHTML = ""; // Clear previous data

        data.forEach(row => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row["Timestamp"] || ""}</td>
            <td>${row["Name of Applicant"] || ""}</td>
            <td>${row["Name of Institution/Organization/Person"] || ""}</td>
            <td>${row["Number of Participants"] || ""}</td>
            <td>${row["Venue"] || ""}</td>
            <td>${row["Event Description"] || ""}</td>
            <td>${row["Event Start Date"] || ""}</td>
            <td>${row["Event End Date"] || ""}</td>
            <td>${row["Additional Services"] || ""}</td>
            <td>${row["Time Event Starts (Please indicate : AM/PM)."] || ""}</td>
            <td>${row["Time Event Ends (Please indicate : AM/PM)"] || ""}</td>
          `;
          tbody.appendChild(tr);
        });
      },
      error: function(error) {
        console.error("Error loading CSV data:", error);
      }
    });
  }

  // Load institutions on page load
  document.addEventListener("DOMContentLoaded", loadInstitutions);
</script>

  

  <script>
    /*******************************
     * Demo data + persistence
     *******************************/
    const sampleVenues = [
      {id:1,name:'Effah Hall (Full Auditorium)', base:12000, withServices:14000},
      {id:2,name:'Effah Hall (Ground Floor)', base:10000, withServices:12000},
      {id:3,name:'Ahmed Jinapor Hall', base:5000, withServices:5000},
      {id:4,name:'Kwame Dattey Hall', base:3500, withServices:3500},
      {id:5,name:'Nikoi Kotey Hall', base:2500, withServices:2500}
    ];

    const sampleInstitutions = [
      {id:1,name:'University of Ghana', coordinator:'Evelyn', email:'evelyn@ug.edu.gh'},
      {id:2,name:'Ghana Health Service', coordinator:'Samuel', email:'samuel@ghs.gov.gh'},
      {id:3,name:'Ministry of Education', coordinator:'Amos', email:'amos@moe.gov.gh'}
    ];

    const sampleUsers = [
      {id:1,name:'Super Admin',email:'super@gtec.edu.gh',role:'Super Admin'},
      {id:2,name:'Finance',email:'finance@gtec.edu.gh',role:'Finance'},
      {id:3,name:'Coordinator',email:'coord@gtec.edu.gh',role:'Coordinator'}
    ];

    // invoices example
    let venues = JSON.parse(localStorage.getItem('gtec_venues')) || sampleVenues;
    let institutions = JSON.parse(localStorage.getItem('gtec_institutions')) || sampleInstitutions;
    let users = JSON.parse(localStorage.getItem('gtec_users')) || sampleUsers;
    let invoices = JSON.parse(localStorage.getItem('gtec_invoices')) || [];

    function persist(){
      localStorage.setItem('gtec_venues', JSON.stringify(venues));
      localStorage.setItem('gtec_institutions', JSON.stringify(institutions));
      localStorage.setItem('gtec_users', JSON.stringify(users));
      localStorage.setItem('gtec_invoices', JSON.stringify(invoices));
      updateUI();
    }

    /*******************************
     * Utilities
     *******************************/
    function qs(sel){return document.querySelector(sel)}
    function qsa(sel){return Array.from(document.querySelectorAll(sel))}

    function showPage(pageId){
      qsa('.page').forEach(p=>p.classList.add('hidden'));
      qs('#'+pageId).classList.remove('hidden');
      qsa('.nav button').forEach(b=>b.classList.toggle('active', b.dataset.page===pageId));
    }

    // format currency
    function fmt(v){return (v||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});}

    // today's date
    qs('#todayDate').textContent = new Date().toLocaleDateString();

    /*******************************
     * Renderers
     *******************************/
    function renderInstitutions(){
      const tbody = qs('#institutionsTable tbody'); tbody.innerHTML = '';
      institutions.forEach(inst=>{
        const count = invoices.filter(i=>i.institutionId===inst.id).length;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${inst.name}</td><td>${inst.coordinator||''}</td><td>${inst.email||''}</td><td>${count}</td><td><button data-id='${inst.id}' class='btn ghost editInst'>Edit</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function renderVenues(){
      const tbody = qs('#venuesTable tbody'); tbody.innerHTML = '';
      venues.forEach(v=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${v.name}</td><td>GHS ${fmt(v.base)}</td><td>GHS ${fmt(v.withServices)}</td><td><button data-id='${v.id}' class='btn ghost editVenue'>Edit</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function renderUsers(){
      const tbody = qs('#usersTable tbody'); tbody.innerHTML = '';
      users.forEach(u=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u.name}</td><td>${u.email}</td><td>${u.role}</td><td><button data-id='${u.id}' class='btn ghost editUser'>Edit</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function renderInvoices(){
      const tbody = qs('#invoicesTable tbody'); tbody.innerHTML = '';
      invoices.slice().reverse().forEach(inv=>{
        const inst = institutions.find(i=>i.id===inv.institutionId) || {name:inv.institution};
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${inv.invoiceNo}</td><td>${inst.name || inv.institution}</td><td>${inv.venue}</td><td>GHS ${fmt(inv.amount)}</td><td>${inv.date}</td><td>${inv.status}</td><td><button class='btn ghost previewInv' data-id='${inv.id}'>Preview</button> <button class='btn' data-id='${inv.id}' data-action='download'>PDF</button></td>`;
        tbody.appendChild(tr);
      });

      // recent
      const recentBody = qs('#recentInvoicesTable tbody'); recentBody.innerHTML = '';
      invoices.slice(-5).reverse().forEach(inv=>{
        const inst = institutions.find(i=>i.id===inv.institutionId) || {name:inv.institution};
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${inv.invoiceNo}</td><td>${inst.name||inv.institution}</td><td>${inv.venue}</td><td>GHS ${fmt(inv.amount)}</td><td>${inv.status}</td>`;
        recentBody.appendChild(tr);
      });
    }

    function updateStats(){
      // Keep booking-related stats updated from local invoices
      qs('#statBookings').textContent = invoices.length;
      qs('#dashBookings').textContent = invoices.length;
      qs('#reportBookings').textContent = invoices.length;

      // Keep reportRevenue computed locally (if you have amounts in invoices)
      const rev = invoices.reduce((s,i)=>s + (i.amount||0),0);
      qs('#reportRevenue').textContent = 'GHS ' + fmt(rev);

      // NOTE: dashPending/dashCancelled/dashCompleted are populated via fetchLiveStats()
    }

    function updateUI(){
      renderInstitutions(); renderVenues(); renderUsers(); renderInvoices(); updateStats(); renderChart();
    }

    
    /*******************************
 * Charts
 *******************************/
let venueChart = null;
async function renderChart(){
  const ctx = document.getElementById('venueChart').getContext('2d');

  // Fetch CSV data
  Papa.parse(sheetCSVUrl, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results){
      const data = results.data;

      // Venue names (use your defined sample venues)
      const labels = venues.map(v => v.name);

      // Count bookings per venue from CSV
      const counts = labels.map(venueName => 
        data.filter(row => row["Venue"] === venueName).length
      );

      // Destroy existing chart if any
      if(venueChart) venueChart.destroy();

      // Create chart
      venueChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Bookings by Venue',
            data: counts,
            backgroundColor: 'rgba(37, 99, 235, 0.7)',
            borderColor: 'rgba(37, 99, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, precision: 0 } }
        }
      });
    },
    error: function(err){
      console.error("Failed to load CSV for chart:", err);
    }
  });
}




    
    /*******************************
     * Interactions: Nav + buttons
     *******************************/
    qsa('.nav button').forEach(b=>b.addEventListener('click',()=>showPage(b.dataset.page)));

    // new booking button opens invoice modal
    qs('#btnNewBooking').addEventListener('click', ()=>openInvoiceModal());
    qs('#btnGenerateInvoice').addEventListener('click', ()=>openInvoiceModal());

    qs('#btnAddInstitution').addEventListener('click', ()=>openInstitutionModal());
    qs('#btnAddVenue').addEventListener('click', ()=>openVenueModal());
    qs('#btnAddUser').addEventListener('click', ()=>openUserModal());

    // export CSV
    qs('#btnExport').addEventListener('click', ()=>{
      const rows = ['InvoiceNo,Institution,Coordinator,Email,Venue,Amount,Date,Status'];
      invoices.forEach(i=>{
        const inst = institutions.find(x=>x.id===i.institutionId) || {name:i.institution, coordinator:'', email:''};
        rows.push([i.invoiceNo, inst.name, inst.coordinator||'', inst.email||'', `\"${i.venue}\"`, i.amount, i.date, i.status].join(','));
      });
      const blob = new Blob([rows.join('\n')],{type:'text/csv'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'invoices_export.csv'; a.click();
    });

    // global search
qs('#globalSearch').addEventListener('input', function(){
  const q = this.value.toLowerCase();

  // --- FILTER INSTITUTIONS ---
  const instTbody = qs('#institutionsTable tbody');
  instTbody.innerHTML = ''; // clear table
  if(q){
    Papa.parse(sheetCSVUrl, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const data = results.data;
        data.forEach(row => {
          const combined = [
            row["Timestamp"] || "",
            row["Name of Applicant"] || "",
            row["Name of Institution/Organization/Person"] || "",
            row["Number of Participants"] || "",
            row["Venue"] || "",
            row["Event Description"] || "",
            row["Event Start Date"] || "",
            row["Event End Date"] || "",
            row["Additional Services"] || "",
            row["Time Event Starts (Please indicate : AM/PM)."] || "",
            row["Time Event Ends (Please indicate : AM/PM)"] || ""
          ].join(' ').toLowerCase();
          
          if(combined.includes(q)){
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${row["Timestamp"] || ""}</td>
              <td>${row["Name of Applicant"] || ""}</td>
              <td>${row["Name of Institution/Organization/Person"] || ""}</td>
              <td>${row["Number of Participants"] || ""}</td>
              <td>${row["Venue"] || ""}</td>
              <td>${row["Event Description"] || ""}</td>
              <td>${row["Event Start Date"] || ""}</td>
              <td>${row["Event End Date"] || ""}</td>
              <td>${row["Additional Services"] || ""}</td>
              <td>${row["Time Event Starts (Please indicate : AM/PM)."] || ""}</td>
              <td>${row["Time Event Ends (Please indicate : AM/PM)"] || ""}</td>
            `;
            instTbody.appendChild(tr);
          }
        });
      }
    });
  } else {
    // reload all institutions if search is empty
    loadInstitutions();
  }

  // --- FILTER INVOICES ---
  const tbody = qs('#invoicesTable tbody'); tbody.innerHTML = '';
  invoices.filter(inv=> [inv.invoiceNo,inv.venue,inv.status,(inv.institution||'')].join(' ').toLowerCase().includes(q)).forEach(inv=>{
    const inst = institutions.find(i=>i.id===inv.institutionId) || {name:inv.institution};
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${inv.invoiceNo}</td><td>${inst.name||inv.institution}</td><td>${inv.venue}</td><td>GHS ${fmt(inv.amount)}</td><td>${inv.date}</td><td>${inv.status}</td><td><button class='btn ghost previewInv' data-id='${inv.id}'>Preview</button> <button class='btn' data-id='${inv.id}' data-action='download'>PDF</button></td>`;
    tbody.appendChild(tr);
  });
});

    

    /*******************************
     * Modal helpers (simple)
     *******************************/
    function openModal(html){
      const root = qs('#modalRoot');
      const wrap = document.createElement('div');
      wrap.style= 'position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:9999';
      wrap.innerHTML = `<div style='max-width:820px;width:100%;padding:18px;background:var(--card);border-radius:12px;box-shadow:var(--shadow)'>${html}<div style='text-align:right;margin-top:12px'><button id='closeModal' class='btn ghost'>Close</button></div></div>`;
      root.appendChild(wrap);
      wrap.querySelector('#closeModal').addEventListener('click', ()=>root.removeChild(wrap));
      return wrap;
    }

    /*******************************
     * Institution CRUD modal
     *******************************/
    function openInstitutionModal(inst){
      inst = inst || {name:'',coordinator:'',email:''};
      const html = `
        <h3>${inst.id? 'Edit':'Add'} Institution</h3>
        <div style='display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px'>
          <div><label>Name</label><input id='instName' value='${inst.name||''}' /></div>
          <div><label>Coordinator</label><input id='instCoord' value='${inst.coordinator||''}' /></div>
          <div style='grid-column:1/3'><label>Email</label><input id='instEmail' value='${inst.email||''}' /></div>
        </div>
        <div style='margin-top:12px;text-align:right'><button id='saveInst' class='btn'>Save</button></div>
      `;
      const modal = openModal(html);
      modal.querySelector('#saveInst').addEventListener('click', ()=>{
        const name = modal.querySelector('#instName').value.trim();
        const coordinator = modal.querySelector('#instCoord').value.trim();
        const email = modal.querySelector('#instEmail').value.trim();
        if(!name) return alert('Enter institution name');
        if(inst.id){ // update
          const idx = institutions.findIndex(i=>i.id===inst.id); institutions[idx] = {...institutions[idx], name, coordinator, email};
        } else {
          const id = Date.now(); institutions.push({id,name,coordinator,email});
        }
        persist(); document.querySelector('#modalRoot').innerHTML='';
      });
    }

    document.addEventListener('click', (e)=>{
      if(e.target.classList.contains('editInst')){
        const id = Number(e.target.dataset.id); const inst = institutions.find(i=>i.id===id); openInstitutionModal(inst);
      }
    });

    /*******************************
     * Venue CRUD modal
     *******************************/
    function openVenueModal(v){
      v = v || {name:'',base:'',withServices:''};
      const html = `
        <h3>${v.id? 'Edit':'Add'} Venue</h3>
        <div style='display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px'>
          <div><label>Venue Name</label><input id='vName' value='${v.name||''}' /></div>
          <div style='display:flex;gap:10px'><div style='flex:1'><label>Base Cost</label><input id='vBase' value='${v.base||''}' type='number' /></div><div style='flex:1'><label>With Services Cost</label><input id='vWith' value='${v.withServices||''}' type='number' /></div></div>
        </div>
        <div style='margin-top:12px;text-align:right'><button id='saveVenue' class='btn'>Save</button></div>
      `;
      const modal = openModal(html);
      modal.querySelector('#saveVenue').addEventListener('click', ()=>{
        const name = modal.querySelector('#vName').value.trim();
        const base = Number(modal.querySelector('#vBase').value)||0;
        const withServices = Number(modal.querySelector('#vWith').value)||base;
        if(!name) return alert('Enter venue name');
        if(v.id){ const idx = venues.findIndex(x=>x.id===v.id); venues[idx] = {...venues[idx], name, base, withServices}; }
        else venues.push({id:Date.now(), name, base, withServices});
        persist(); document.querySelector('#modalRoot').innerHTML='';
      });
    }

    document.addEventListener('click', (e)=>{
      if(e.target.classList.contains('editVenue')){
        const id = Number(e.target.dataset.id); const v = venues.find(i=>i.id===id); openVenueModal(v);
      }
    });

    /*******************************
     * User CRUD
     *******************************/
    function openUserModal(u){
      u = u || {name:'',email:'',role:'Coordinator'};
      const html = `
        <h3>${u.id? 'Edit':'Add'} User</h3>
        <div style='display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px'>
          <div><label>Name</label><input id='uName' value='${u.name||''}' /></div>
          <div><label>Email</label><input id='uEmail' value='${u.email||''}' /></div>
          <div style='grid-column:1/3'><label>Role</label><select id='uRole'><option>Super Admin</option><option>Admin</option><option>Finance</option><option>Coordinator</option></select></div>
        </div>
        <div style='margin-top:12px;text-align:right'><button id='saveUser' class='btn'>Save</button></div>
      `;
      const modal = openModal(html);
      modal.querySelector('#uRole').value = u.role || 'Coordinator';
      modal.querySelector('#saveUser').addEventListener('click', ()=>{
        const name = modal.querySelector('#uName').value.trim();
        const email = modal.querySelector('#uEmail').value.trim();
        const role = modal.querySelector('#uRole').value;
        if(!name || !email) return alert('Enter user name and email');
        if(u.id){ const idx = users.findIndex(x=>x.id===u.id); users[idx] = {...users[idx], name, email, role}; }
        else users.push({id:Date.now(), name, email, role});
        persist(); document.querySelector('#modalRoot').innerHTML='';
      });
    }
    document.addEventListener('click', (e)=>{ if(e.target.classList.contains('editUser')){ const id=Number(e.target.dataset.id); openUserModal(users.find(u=>u.id===id)); } });

    /*******************************
     * Invoice Modal + generate
     *******************************/
    function generateInvoiceNo(){
      const prefix='GTEC'; const t = Date.now().toString().slice(-6); return `${prefix}-${t}`;
    }

    function openInvoiceModal(prefill){
      const instOptions = institutions.map(i=>`<option value='${i.id}'>${i.name}</option>`).join('');
      const venueOptions = venues.map(v=>`<option value='${v.name}'>${v.name}</option>`).join('');
      const html = `
        <h3>Generate Invoice</h3>
        <div style='display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px'>
          <div><label>Institution</label><select id='invInst'><option value=''>-- select --</option>${instOptions}</select></div>
          <div><label>Coordinator Email</label><input id='invEmail' placeholder='coordinator@example.com' /></div>
          <div><label>Venue</label><select id='invVenue'><option value=''>-- select --</option>${venueOptions}</select></div>
          <div><label>With Additional Services?</label><select id='invService'><option value='no'>No</option><option value='yes'>Yes</option></select></div>
          <div><label>Date</label><input id='invDate' type='date' value='${new Date().toISOString().slice(0,10)}' /></div>
          <div><label>Invoice No</label><input id='invNo' readonly value='${generateInvoiceNo()}' /></div>
        </div>
        <div style='display:flex;gap:8px;margin-top:12px;align-items:center'><button id='calcCost' class='btn ghost'>Calculate</button><div class='muted'>Amount: <b id='calcAmount'>GHS 0.00</b></div></div>
        <div style='margin-top:12px;text-align:right'><button id='saveInvoice' class='btn'>Save & Preview</button></div>
      `;
      const modal = openModal(html);

      modal.querySelector('#invInst').addEventListener('change', function(){
        const inst = institutions.find(i=>i.id==this.value); if(inst) modal.querySelector('#invEmail').value = inst.email||'';
      });

      modal.querySelector('#calcCost').addEventListener('click', ()=>{
        const venueName = modal.querySelector('#invVenue').value; const want = modal.querySelector('#invService').value==='yes';
        const v = venues.find(vv=>vv.name===venueName);
        const amt = v ? (want? v.withServices: v.base) : 0;
        modal.querySelector('#calcAmount').textContent = 'GHS ' + fmt(amt);
      });

      modal.querySelector('#saveInvoice').addEventListener('click', ()=>{
        const instId = Number(modal.querySelector('#invInst').value)||null;
        const email = modal.querySelector('#invEmail').value.trim();
        const venue = modal.querySelector('#invVenue').value;
        const want = modal.querySelector('#invService').value==='yes';
        const v = venues.find(vv=>vv.name===venue);
        const amount = v ? (want? v.withServices: v.base) : 0;
        const date = modal.querySelector('#invDate').value;
        const invoiceNo = modal.querySelector('#invNo').value;
        const id = Date.now();
        invoices.push({id, invoiceNo, institutionId:instId, institution: instId? null : 'Manual', coordinatorEmail:email, venue, amount, date, status:'Pending'});
        persist();
        // open preview
        openInvoicePreview(id);
        document.querySelector('#modalRoot').innerHTML='';
      });
    }

    /*******************************
     * Preview + download invoice (simple template)
     *******************************/
    function openInvoicePreview(invId){
      const inv = invoices.find(i=>i.id===invId);
      const inst = institutions.find(i=>i.id===inv.institutionId) || {name:inv.institution||'Manual'};
      const html = `
        <div id='invoicePreview'>
          <div style='display:flex;justify-content:space-between;align-items:center'><div><h2>GTEC HOSPITALITY MANAGEMENT SERVICES</h2><div>P.O.BOX MB 28, MINISTRIES ‚Äì ACCRA</div></div><div style='text-align:right'><div><b>Invoice No:</b> ${inv.invoiceNo}</div><div><b>Date:</b> ${inv.date}</div></div></div>
          <hr style='margin:12px 0' />
          <div style='display:flex;justify-content:space-between'><div><b>Coordinator:</b> ${inst.name}</div><div><b>Email:</b> ${inv.coordinatorEmail||''}</div></div>
          <div style='margin-top:12px'>
            <table style='width:100%;border-collapse:collapse' border='1'><thead><tr><th>SI No</th><th>Description</th><th>Amount</th></tr></thead><tbody><tr><td>1</td><td>${inv.venue}</td><td>GHS ${fmt(inv.amount)}</td></tr><tr><td colspan='2' style='text-align:right'><b>TOTAL</b></td><td><b>GHS ${fmt(inv.amount)}</b></td></tr></tbody></table>
          </div>
          <div style='margin-top:20px;text-align:right'><button id='dlPdf' class='btn'>Download PDF</button></div>
        </div>
      `;
      const modal = openModal(html);
      modal.querySelector('#dlPdf').addEventListener('click', ()=>{
        const opt = {filename:`${inv.invoiceNo}.pdf`,jsPDF:{unit:'pt',format:'a4'}};
        html2pdf().from(modal.querySelector('#invoicePreview')).set(opt).save();
      });
    }

    document.addEventListener('click', (e)=>{
      if(e.target.classList.contains('previewInv')){ const id = Number(e.target.dataset.id); openInvoicePreview(id); }
      if(e.target.dataset.action==='download'){ const id = Number(e.target.dataset.id); openInvoicePreview(id); }
    });

    /*******************************
     * Live stats fetch from Google Apps Script Web App
     *******************************/
    const LIVE_STATS_URL = "https://script.google.com/macros/s/AKfycbzXyA69pX8nMGJjpVm-XFo4Vbk-w0CSBeN6-Y0uQQtEKKoZatbV8KisJLqMcKtyeZx4/exec";

    async function fetchLiveStats(){
      try {
        const res = await fetch(LIVE_STATS_URL, {cache: "no-store"});
        if(!res.ok){
          console.warn("Live stats fetch failed:", res.status);
          return;
        }
        const data = await res.json();
        // expected structure: {"Pending":10,"Cancelled":4,"Completed":16}
        if(typeof data === 'object' && data !== null){
          const pending = data.Pending || 0;
const cancelled = data.Cancelled || 0;
const completed = data.Completed || 0;

qs('#dashPending').textContent = pending;
qs('#dashCancelled').textContent = cancelled;
qs('#dashCompleted').textContent = completed;

// update total bookings as sum of the three
qs('#dashBookings').textContent = pending + cancelled + completed;
qs('#statBookings').textContent = pending + cancelled + completed;
qs('#reportBookings').textContent = pending + cancelled + completed;

// optional: keep reportPending updated
qs('#reportPending').textContent = pending;


          
        }
      } catch (err){
        console.error("Error fetching live stats:", err);
      }
    }

    /*******************************
     * Init
     *******************************/
    document.addEventListener('DOMContentLoaded', ()=>{
      updateUI(); showPage('dashboard');
      // fetch live stats immediately and then every 30s
      fetchLiveStats();
      setInterval(fetchLiveStats, 30000);
    });

  </script>
</body>
</html>



















